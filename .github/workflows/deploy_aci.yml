name: Build & Deploy to Azure Container Instances (ACI)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ACI_RG: ${{ secrets.ACI_RG }}
      ACI_NAME: ${{ secrets.ACI_NAME }}
      APP_PORT: 18080
      ACI_DNS_LABEL: ${{ secrets.ACI_DNS_LABEL }}
      LOG_WORKSPACE_ID: ${{ secrets.LOG_WORKSPACE_ID}}
      LOG_PRIMARY_KEY: ${{ secrets.LOG_PRIMARY_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR login server
        id: acrls
        run: |
          LOGIN_SERVER=$(az acr show -n "$ACR_NAME" --query loginServer -o tsv)
          echo "login_server=$LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Get ACR credentials
        id: acr
        run: |
          echo "username=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show -n "$ACR_NAME" --query 'passwords[0].value' -o tsv)" >> $GITHUB_OUTPUT

      - name: Docker login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ steps.acrls.outputs.login_server }}
          username: ${{ steps.acr.outputs.username }}
          password: ${{ steps.acr.outputs.password }}

      # 3) Build & Push（tag 用短 sha，方便看）
      - name: Build and push
        run: |
          TAG="${GITHUB_SHA::7}"
          IMAGE="${{ steps.acrls.outputs.login_server }}/tradeverse-api:${TAG}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # 4) Deploy/Update ACI
      - name: Deploy to ACI
        run: |
          set -euo pipefail
          PORT="${{ env.APP_PORT }}"
          RG="${{ secrets.ACI_RG }}"
          ACI_NAME="${{ secrets.ACI_NAME }}"
          DNS_LABEL="${{ secrets.ACI_DNS_LABEL }}"
          LOGIN_SERVER="${{ steps.acrls.outputs.login_server }}"
          USERNAME="${{ steps.acr.outputs.username }}"
          PASSWORD="${{ steps.acr.outputs.password }}"

          echo "Deploying image: $IMAGE"
          echo "RG=$RG ACI_NAME=$ACI_NAME DNS_LABEL=$DNS_LABEL PORT=$PORT LOGIN_SERVER=$LOGIN_SERVER"

          if [ -z "$RG" ] || [ -z "$ACI_NAME" ] || [ -z "$LOGIN_SERVER" ] || [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
            echo "Missing required values. Check secrets/step outputs."
            exit 1
          fi

          az container delete -g "$RG" -n "$ACI_NAME" --yes || true

          DNS_ARGS=()
          if [ -n "$DNS_LABEL" ]; then
            DNS_ARGS+=(--dns-name-label "$DNS_LABEL")
          fi

          # ---- build DNS label args ----
          DNS_ARGS=()
          if [ -n "$DNS_LABEL" ]; then
            DNS_ARGS+=(--dns-name-label "$DNS_LABEL")
          fi

          # ---- credentials.json as secret file ----
          printf '%s' '${{ secrets.GMAIL_CREDENTIAL }}' > credentials.json
          printf '%s' '${{ secrets.GMAIL_TOKEN }}' > token.json

          CRED_CONTENT="$(cat credentials.json)"
          TOKEN_CONTENT="$(cat token.json)"

          az container create \
            -g "$RG" \
            -n "$ACI_NAME" \
            --image "$IMAGE" \
            --os-type Linux \
            --ip-address Public \
            --ports $PORT \
            --cpu 1 \
            --memory 1.5 \
            --registry-login-server "$LOGIN_SERVER" \
            --registry-username "$USERNAME" \
            --registry-password "$PASSWORD" \
            --restart-policy Always \
            --environment-variables \
              DALINK_GO_CONFIG_PATH=/app/config/dev.yml \
              DATABASE_HOST='${{ secrets.DATABASE_HOST }}' \
              DATABASE_USER='${{ secrets.DATABASE_USER }}' \
              DATABASE_PORT='${{ secrets.DATABASE_PORT }}' \
              GMAIL_APP_ACC='${{ secrets.GMAIL_APP_ACC }}' \
              GMAIL_SENDER='${{ secrets.GMAIL_SENDER }}' \
              GMAIL_TEST_TO='${{ secrets.GMAIL_TEST_TO }}' \
              GMAIL_CREDENTIAL=/mnt/secrets/credentials.json \
              GMAIL_TOKEN=/mnt/secrets/token.json \
            --secure-environment-variables \
              DATABASE_PWD='${{ secrets.DATABASE_PWD }}' \
              GMAIL_APP_PWD='${{ secrets.GMAIL_APP_PWD }}' \
            --secrets \
              credentials.json="$CRED_CONTENT" \
              token.json="$TOKEN_CONTENT" \
            --secrets-mount-path /mnt/secrets \
            --log-analytics-workspace "$LOG_WORKSPACE_ID" \
            --log-analytics-workspace-key "$LOG_PRIMARY_KEY" \
            "${DNS_ARGS[@]}"

          echo "== Env in ACI (must NOT be empty) =="
          az container show -g "$RG" -n "$ACI_NAME" --query "containers[0].environmentVariables" -o jsonc

          echo "== State =="
          az container show -g "$RG" -n "$ACI_NAME" --query "containers[0].instanceView.currentState" -o jsonc

          echo "Public IP:"
          az container show -g "$RG" -n "$ACI_NAME" --query ipAddress.ip -o tsv

          echo "FQDN (if any):"
          az container show -g "$RG" -n "$ACI_NAME" --query ipAddress.fqdn -o tsv
          